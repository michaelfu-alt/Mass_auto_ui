# 质谱自动化上位机 UI 方案说明

## 一、项目背景
本项目旨在实现质谱仪与化学吸附仪联动的自动化控制。当吸附仪加热炉的温度达到设定阈值 **m℃** 且次数为 **n** 时，自动触发质谱采集启动指令，从而减少人工干预并提高同步测试的精度与一致性。

## 二、UI 总体设计
上位机采用 PySide6 实现简洁可视化界面，结构如下：

```
┌───────────────────────────────────────────────┐
│ 🔥 炉温监控与启动控制面板                   │
├───────────────────────────────────────────────┤
│ [串口设置]  COM3 ⬇️   [连接] [断开]         │
│ 实时温度： 48.6 ℃    状态：🟡 正在监控       │
├───────────────────────────────────────────────┤
│ 启动条件设置                                 │
│ ├ 启动温度 m (℃)： [ 50.0 ]                 │
│ ├ 触发次数 n ：     [ 2 ]                   │
│ └ [设定条件] [清除条件]                      │
├───────────────────────────────────────────────┤
│ 日志信息输出                                 │
│ ┌───────────────────────────────────────────┐│
│ │ [13:21:06] 串口已连接 COM3                 ││
│ │ [13:22:15] 当前温度 49.8 ℃                ││
│ │ [13:24:10] 第 2 次到达 50 ℃，触发成功！   ││
│ │ [13:24:11] 已启动质谱采集脚本              ││
│ └───────────────────────────────────────────┘│
├───────────────────────────────────────────────┤
│ [启动监控] [停止监控] [测试脚本] [退出]       │
└───────────────────────────────────────────────┘
```

界面模块：
- 串口控制区：选择端口、波特率、连接状态。
- 启动条件区：设定升温触发条件。
- 日志窗口：实时输出采集与指令反馈。
- 控制区：启动 / 停止 / 测试脚本。

## 三、功能模块说明
| 模块 | 功能描述 |
|------|-----------|
| SerialWorker | 负责下位机串口通讯与温度读取 |
| TriggerController | 判断温度与触发次数是否满足条件 |
| ScriptRunner | 调用质谱启动脚本或点击启动按钮 |
| LogDisplay | 实时输出事件与温度数据 |
| MainWindow | 集成 UI 与控制逻辑 |

## 四、串口通信与指令逻辑
下位机使用 CH340 模块，通信参数：
- 波特率：9600 bps  
- 数据长度：8 bits  
- 停止位：1 bit  
- 校验：无  
- 握手协议：无

### 上位机发送：
| 起始字节 | 数据长度 | 数据命令 | 校验高 | 校验低 | 停止字节 | 含义 |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
| 73 | 02 | 01 | 00 | 02 | 65 | TEMP采集开始 |
| 73 | 02 | 00 | 00 | 01 | 65 | TEMP采集结束 |

### 下位机返回：
```
73 04 01 4F('O') 4B('K') 00 9C 65
→ 表示 OK 确认指令
```

温度数据示例：
```
TEMP=1000℃
```
下位机每 0.5 秒发送一次。

## 五、触发机制与质谱启动
当检测到第 n 次温度达到 m℃ 时：
1. 校验温度稳定（2 秒内连续判定）；
2. 若质谱软件未运行 → 通过 `subprocess.Popen()` 启动；
3. 若质谱软件已运行 → 使用 `pyautogui` 模拟点击采集按钮；
4. 返回日志与状态更新。

## 六、扩展与优化方向
- 实时温度曲线绘制（matplotlib）
- 多点触发条件与脚本选择
- 自动日志保存与时间戳记录
- 程序状态灯与报警机制
- 串口设备自动识别与错误恢复

---

本方案兼顾科学仪器自动化与易用性，可作为质谱与化学吸附耦合实验的标准上位机模板。
